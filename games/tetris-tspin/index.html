<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-en="Tetris (T-Spin)" data-zh-HK="俄羅斯方塊 (T-Spin)">Tetris (T-Spin)</title>
    <link rel="stylesheet" href="../../assets/style.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
        background-color: #202028;
        color: #fff;
        transition: background-color 0.3s, color 0.3s;
      }
      body.light-mode {
        background-color: #f0f0f0;
        color: #333;
      }
      #tetris {
        border: 2px solid #fff;
        background-color: #000;
      }
      body.light-mode #tetris {
        border-color: #333;
      }
      .game-container {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        justify-content: center;
        margin-top: 20px;
      }
      .left-panel,
      .right-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
        min-width: 120px;
      }
      .right-panel {
        align-items: flex-start;
      }
      .left-panel {
        align-items: flex-end;
        text-align: right;
      }
      .controls-info {
        margin-top: 20px;
        font-size: 0.9em;
        color: #aaa;
        max-width: 200px;
      }
      body.light-mode .controls-info {
        color: #666;
      }
      .preview-box {
        margin-top: 10px;
        text-align: center;
        background: rgba(0, 0, 0, 0.2);
        padding: 10px;
        border-radius: 8px;
      }
      .preview-box canvas {
        border: none; /* Remove border to make them look closer */
        background-color: transparent;
        margin-top: 5px;
      }
      /* Reset background for canvases in queue if needed, or keep transparent */
      #next-queue canvas {
          background-color: transparent;
      }
      body.light-mode .preview-box canvas {
        border-color: #ccc;
      }
      button#startBtn {
        padding: 10px 20px;
        font-size: 1.2em;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        margin-top: 10px;
      }
      button#startBtn:hover {
        background-color: #45a049;
      }
      .mobile-preview-row {
        display: none;
        width: 100%;
        justify-content: center;
        gap: 12px;
      }
      .mobile-preview-row .preview-box {
        flex: 1;
        max-width: 140px;
      }

      /* Mobile Controls */
      .mobile-controls {
        display: none;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
        width: 100%;
        max-width: 300px;
      }
      .control-row {
        display: flex;
        justify-content: center;
        gap: 20px;
      }
      .control-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.1);
        border: 2px solid #666;
        color: #fff;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        cursor: pointer;
        touch-action: manipulation;
      }
      .control-btn:active {
        background-color: rgba(255, 255, 255, 0.3);
      }
      body.light-mode .control-btn {
        background-color: rgba(0, 0, 0, 0.1);
        border-color: #ccc;
        color: #333;
      }
      body.light-mode .control-btn:active {
        background-color: rgba(0, 0, 0, 0.2);
      }

      #drop-btn {
        width: 80px;
        height: 80px;
        font-size: 30px;
        border-color: #d32f2f;
        background-color: rgba(211, 47, 47, 0.2);
      }

      @media (max-width: 768px) {
        body {
          padding-bottom: 300px; /* Increase space for fixed controls */
          overflow-y: auto; /* Ensure scrolling is possible */
        }
        .game-container {
          flex-direction: column;
          align-items: center;
          justify-content: flex-start;
          margin-top: 10px;
          gap: 15px;
        }
        .left-panel,
        .right-panel {
          flex-direction: row;
          flex-wrap: wrap;
          justify-content: center;
          width: 100%;
          align-items: center; /* Vertically center items in the row */
          text-align: center;
          gap: 20px;
          min-width: 0; /* Allow shrinking */
        }
        
        /* Reset alignments from desktop */
        .left-panel { align-items: center; text-align: center; }
        .right-panel { align-items: center; }

        /* Mobile Layout Order */
        .left-panel { order: 1; }
        canvas#tetris { order: 2; margin: 10px 0; }
        .right-panel { order: 3; }
        
        /* Adjust preview boxes on mobile */
        .preview-box {
            margin: 0; /* Remove desktop margin */
            flex: 0 0 auto; /* Don't stretch */
        }
        
        #next-queue canvas:not(:first-child) {
          display: none; /* Only show first next piece on mobile to save space */
        }
        
        .status-group {
            display: flex;
            flex-direction: row !important; /* Force row for score/level on mobile */
            gap: 20px !important;
            justify-content: center;
            width: 100%;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 200px; /* Limit button width */
        }

        /* Hide keyboard controls info on mobile */
        .controls-info, .controls-info ul {
          display: none !important;
        }
        .mobile-preview-row {
          display: flex;
        }
        .mobile-preview-row .preview-box {
          max-width: 160px;
        }
        
        /* Show gesture info */
        .gesture-info {
           display: block !important;
           margin: 10px auto;
           font-size: 0.9em;
           color: #aaa;
           text-align: center;
           width: 100%;
           background: rgba(0,0,0,0.2);
           padding: 10px;
           border-radius: 8px;
        }
      }

      .gesture-info {
        display: none;
      }

      /* Speed Slider Styles */
      #speedControl {
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
      }
      #speedSlider {
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        border-radius: 3px;
        background: #555;
        outline: none;
        cursor: pointer;
      }
      #speedSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #e91e63;
        cursor: pointer;
      }
      #speedSlider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #e91e63;
        cursor: pointer;
        border: none;
      }
      body.light-mode #speedSlider {
        background: #ccc;
      }
      body.light-mode #speedSlider::-webkit-slider-thumb {
        background: #e91e63;
      }
      body.light-mode #speedSlider::-moz-range-thumb {
        background: #e91e63;
      }
      body.light-mode #speedValue {
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1 data-en="Tetris (T-Spin)" data-zh-HK="俄羅斯方塊 (T-Spin)">Tetris (T-Spin)</h1>

    <div class="game-container">
      <!-- Left Panel: Status & Hold -->
      <div class="left-panel">
        <div class="preview-box">
          <div data-en="Hold" data-zh-HK="暫存">Hold</div>
          <canvas id="hold" width="100" height="100"></canvas>
        </div>

        <div class="status-group">
          <div id="score" data-en="Score: 0" data-zh-HK="分數: 0" style="font-size: 1.2em; font-weight: bold;">Score: 0</div>
          <div id="level" data-en="Level: 1" data-zh-HK="等級: 1" style="font-size: 1.2em;">Level: 1</div>
        </div>
        
        <div class="controls-info">
          <p data-en="Controls:" data-zh-HK="操作說明:">Controls:</p>
          <ul style="padding-left: 20px; margin-top: 5px">
            <li data-en="← → : Move" data-zh-HK="← → : 移動">← → : Move</li>
            <li data-en="↓ : Soft Drop" data-zh-HK="↓ : 加速下落">↓ : Soft Drop</li>
            <li data-en="Space : Hard Drop" data-zh-HK="空白鍵 : 直接落下">Space : Hard Drop</li>
            <li data-en="↑ / Q / W : Rotate" data-zh-HK="↑ / Q / W : 旋轉">↑ / Q / W : Rotate</li>
            <li data-en="C / Shift : Hold" data-zh-HK="C / Shift : 暫存">C / Shift : Hold</li>
          </ul>
        </div>
      </div>

      <!-- Center: Game Board -->
      <canvas id="tetris" width="240" height="400"></canvas>

      <!-- Right Panel: Next Queue & Buttons -->
      <div class="right-panel">
        <div class="preview-box">
          <div data-en="Next" data-zh-HK="下一個">Next</div>
          <div id="next-queue" style="display: flex; flex-direction: column; align-items: center;">
             <canvas id="next" width="100" height="100"></canvas>
          </div>
        </div>

        <div class="button-group">
          <button id="startBtn" data-en="Start Game" data-zh-HK="開始遊戲">Start Game</button>
          <button id="matrixBtn" data-en="Toggle Matrix View" data-zh-HK="切換矩陣視圖" style="margin-top: 10px; background-color: #00bcd4">
            Toggle Matrix View
          </button>
          <button id="autoBtn" data-en="Auto Solver (Normal)" data-zh-HK="自動解題 (一般)" style="margin-top: 10px; background-color: #9c27b0">
            Auto Solver (Normal)
          </button>
          <button id="tspinAutoBtn" data-en="Auto Solver (T-Spin)" data-zh-HK="自動解題 (T-Spin)" style="margin-top: 10px; background-color: #e91e63">
            Auto Solver (T-Spin)
          </button>
          <div id="speedControl" style="margin-top: 15px; display: none; width: 100%;">
            <label for="speedSlider" style="display: block; margin-bottom: 5px; font-size: 0.9em;" data-en="Auto Solver Speed" data-zh-HK="自動解題速度">Auto Solver Speed</label>
            <input type="range" id="speedSlider" min="10" max="1000" value="300" style="width: 100%;">
            <div id="speedValue" style="text-align: center; font-size: 0.8em; margin-top: 5px; color: #aaa;" data-en="300ms" data-zh-HK="300毫秒">300ms</div>
          </div>
          <button id="demoSetupBtn" data-en="Demo T-Spin Setup" data-zh-HK="T-Spin 演示設置" style="margin-top: 10px; background-color: #FF9800">
            Demo T-Spin Setup
          </button>
          <button id="demoDTCannonBtn" data-en="Demo DT Cannon" data-zh-HK="DT 炮演示" style="margin-top: 10px; background-color: #FF5722">
            Demo DT Cannon
          </button>
          <button id="debugEffectBtn" data-en="Trigger T-Spin Effect" data-zh-HK="觸發 T-Spin 特效" style="margin-top: 10px; background-color: #607d8b">
            Trigger T-Spin Effect
          </button>
          <a href="intro.html" style="margin-top: 15px; color: #aaa; text-decoration: none; font-size: 0.9em; text-align: center; display: block;" data-en="Game Guide & Logic" data-zh-HK="遊戲指南與邏輯">Game Guide & Logic</a>
        </div>
      </div>

    <script src="game.js"></script>
    <script>
      // Speed slider control
      (function() {
        const speedControl = document.getElementById('speedControl');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const autoBtn = document.getElementById('autoBtn');
        const tspinAutoBtn = document.getElementById('tspinAutoBtn');
        
        if (!speedControl || !speedSlider || !speedValue) return;
        
        // Show/hide slider based on auto solver state
        const updateSliderVisibility = () => {
          if (typeof isAutoSolver !== 'undefined') {
            speedControl.style.display = isAutoSolver ? 'block' : 'none';
          }
        };
        
        // Update speed value display
        const updateSpeedDisplay = () => {
          const value = parseInt(speedSlider.value);
          const lang = document.documentElement.lang;
          speedValue.textContent = value + (lang === 'zh-Hant' ? '毫秒' : 'ms');
          
          // Update game speed if auto solver is active
          if (typeof setAutoSolverSpeed === 'function') {
            setAutoSolverSpeed(value);
          }
        };
        
        speedSlider.addEventListener('input', updateSpeedDisplay);
        
        // Monitor auto solver button states
        const observer = new MutationObserver(updateSliderVisibility);
        if (autoBtn) {
          observer.observe(autoBtn, { attributes: true, attributeFilter: ['style'] });
        }
        if (tspinAutoBtn) {
          observer.observe(tspinAutoBtn, { attributes: true, attributeFilter: ['style'] });
        }
        
        // Also check periodically (fallback)
        setInterval(updateSliderVisibility, 100);
        
        // Initial update
        updateSpeedDisplay();
        updateSliderVisibility();
      })();
    </script>
    <script>
      (function () {
        const leftPanel = document.querySelector(".left-panel");
        const rightPanel = document.querySelector(".right-panel");
        if (!leftPanel || !rightPanel) return;

        const holdPreview = leftPanel.querySelector(".preview-box");
        const nextPreview = rightPanel.querySelector(".preview-box");
        const statusGroup = leftPanel.querySelector(".status-group");
        const buttonGroup = rightPanel.querySelector(".button-group");
        if (!holdPreview || !nextPreview || !statusGroup || !buttonGroup) return;

        const mobileRow = document.createElement("div");
        mobileRow.className = "mobile-preview-row";

        const mq = window.matchMedia("(max-width: 768px)");

        const moveToMobile = () => {
          if (!mobileRow.contains(holdPreview)) {
            mobileRow.appendChild(holdPreview);
          }
          if (!mobileRow.contains(nextPreview)) {
            mobileRow.appendChild(nextPreview);
          }
          if (mobileRow.parentNode !== rightPanel) {
            rightPanel.insertBefore(mobileRow, buttonGroup);
          }
        };

        const moveToDesktop = () => {
          if (mobileRow.contains(nextPreview)) {
            rightPanel.insertBefore(nextPreview, buttonGroup);
          }
          if (mobileRow.contains(holdPreview)) {
            leftPanel.insertBefore(holdPreview, statusGroup);
          }
          if (mobileRow.parentNode) {
            mobileRow.parentNode.removeChild(mobileRow);
          }
        };

        const updatePlacement = () => {
          if (mq.matches) {
            moveToMobile();
          } else {
            moveToDesktop();
          }
        };

        if (typeof mq.addEventListener === "function") {
          mq.addEventListener("change", updatePlacement);
        } else if (typeof mq.addListener === "function") {
          mq.addListener(updatePlacement);
        }

        updatePlacement();
      })();
    </script>
    <script type="module">
      import { initThemeToggle } from "../../assets/theme-toggle.js";
      import { initLocaleMenu } from "../../assets/locale-menu.js";
      import { initHeader } from "../../assets/header.js";

      initHeader("../../index.html");
      initThemeToggle();
      initLocaleMenu();
    </script>
  </body>
</html>
